---
- hosts: all
  vars_files:
    - vars.yml
    # - @vault.yml
  gather_facts: true
  become: true
  become_user: "{{ project_name }}"
  tasks:

  - cronvar:
      name: MAILTO
      value: "{{ cron_email|format(ec2_tag_Name|default('wcivf')) }}"
      user: "{{ project_name }}"

  - name: "Process log queue"
    cron:
      name: "Process log queue"
      job: "/usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py process_log_queue"

  - name: "Import wikipedia"
    cron:
      name: "Import wikipedia"
      minute: "30"
      hour: 1
      job: "/usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_wikipedia_bios"
      disabled: no

  - name: "Import Elections"
    cron:
      name: "Import Elections"
      minute: "10"
      hour: "*/2"
      job: "/usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_elections"
      disabled: no

  - name: "Import Posts"
    cron:
      name: "Import Posts"
      minute: "30"
      hour: "*/2"
      job: "/usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_posts"
      disabled: no

  - name: "Import Parties"
    cron:
      name: "Import Parties"
      minute: "35"
      hour: "*/2"
      job: "/usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_parties"
      disabled: no

  - name: "Import People"
    cron:
      name: "Import People"
      minute: "40"
      hour: "*/2"
      job: "/usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_people"
      disabled: no

  - name: "Import Recent People"
    cron:
      name: "Import Recent People"
      job: "/usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_people --recent"
      disabled: no

  - name: "Import Companies"
    cron:
      name: "Import Companies"
      hour: "2"
      job: "curl --silent 'https://raw.githubusercontent.com/EdwardBetts/companies-house/master/companies.csv' > /tmp/companies.csv && /usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_companies /tmp/companies.csv"
      disabled: yes

  - name: "Import Hustings"
    cron:
      name: "Import Hustings"
      minute: "*/5"
      job: "curl --silent 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS69t7eXf9Cvwm9BSzhb1-uRj2CfdD1IGUcIQCRuls5DfdyvpcBr_hG5AiSFLFIZGidB0M0-DzKNNUZ/pub?gid=0&single=true&output=csv' > /tmp/hustings.csv && /usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_hustings /tmp/hustings.csv --quiet"
      disabled: yes

  - name: "Import Manifestos"
    cron:
      name: "Import Manifestos"
      minute: "15"
      job: "curl --silent 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS3pC0vtT9WaCyKDzqARQZY6aoYCyKZLyIvumKaX3TpqG0rt4y0fXp6dOPOZGMX6v0dFczHfizwidwZ/pub?gid=582783400&single=true&output=csv' > /tmp/manifestos.csv && /usr/local/bin/output-on-error /var/www/wcivf/env/bin/python /var/www/wcivf/code/manage.py import_manifestos /tmp/manifestos.csv"
      disabled: yes

  - name: "Import local party info"
    cron:
      name: "Import Local Parties"
      minute: "*/5"
      job: "curl --silent 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS3pC0vtT9WaCyKDzqARQZY6aoYCyKZLyIvumKaX3TpqG0rt4y0fXp6dOPOZGMX6v0dFczHfizwidwZ/pub?gid=582783400&single=true&output=csv' > /tmp/local_parties.csv && /usr/local/bin/output-on-error /var/www/wcivf/env/bin/python /var/www/wcivf/code/manage.py  import_local_parties /tmp/local_parties.csv"
      disabled: yes

  - name: "Import local party info"
    cron:
      name: "Import Pledges"
      minute: "*/5"
      job: "curl --silent 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvUX2DZEUwj43eVab7xp5tq3ocD28ol-QiQEWZOExMnI52Ih9pF1LwbZZGzKZE3wRQDtrRIwIM3dLA/pub?gid=0&single=true&output=csv' > /tmp/pledges.csv && /usr/local/bin/output-on-error /var/www/wcivf/env/bin/python /var/www/wcivf/code/manage.py  import_candidate_pledges /tmp/pledges.csv"
      disabled: yes

  - name: "Import CVs"
    cron:
      name: "Import CVs"
      hour: "*/2"
      job: "/usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_cvs"
      disabled: yes

  - name: "Import Leaflets"
    cron:
      name: "Import Leaflets"
      hour: "4"
      job: "/usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_leaflets"
      disabled: yes

  - name: "Import Nesta Backgrounds"
    cron:
      name: "Import Nesta Backgrounds"
      hour: "2"
      job: "curl --silent 'https://docs.google.com/spreadsheets/d/19_o6rm6sfrkO-C4PPZXSDl2bCWjdCJ8a7lbG4vz4JbM/pub?gid=1658209649&single=true&output=csv' > /tmp/nesta.csv && /usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_nesta_backgrounds /tmp/nesta.csv"
      disabled: yes

  - name: "Import Results Atom"
    cron:
      name: "Import Results Atom"
      job: "/usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_results_atom"
      disabled: yes

  - name: "Import Votes Cast"
    cron:
      minute: "1"
      hour: "*/2"
      name: "Import Votes Cast"
      job: "/usr/local/bin/output-on-error /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py import_votes_cast"
      disabled: no
    when: wcivf_controller is not defined


# Reboot jobs
  - name: Init data on restart
    cron:
      name: "Init data"
      special_time: reboot
      job: "sleep 30s && {{ project_root }}/load_database_from_s3.sh && /var/www/{{ project_name }}/env/bin/python /var/www/{{ project_name }}/code/manage.py init_data"



# Controller jobs
  - name: Back up data to S3
    cron:
      name: "Back up data"
      minute: 16
      job: "/usr/local/bin/output-on-error ~/backup_db_to_s3.sh"
    when: wcivf_controller is defined

  - name: Batch feedback to Slack
    cron:
      name: "Batch feedback to Slack"
      minute: 0
      hour: 9
      job: "/usr/local/bin/output-on-error /var/www/wcivf/env/bin/python /var/www/wcivf/code/manage.py batch_feedback_to_slack --hours=24"
    when: wcivf_controller is defined

  - name: Init full data at 20 past
    cron:
      name: "Init data"
      minute: 20
      hour: 0
      job: "/usr/local/bin/output-on-error /var/www/wcivf/env/bin/python /var/www/wcivf/code/manage.py init_data --full"
      disabled: yes
    when: wcivf_controller is defined
